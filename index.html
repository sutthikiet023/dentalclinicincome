<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>คลินิกทันตกรรมบ้านฟัน - ระบบรายงาน</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts (Sarabun for Thai) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Use Sarabun font as the default */
        body {
            font-family: 'Sarabun', sans-serif;
        }
        /* Custom styles for better appearance */
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .summary-card {
            border-left: 5px solid;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-cyan-700">คลินิกทันตกรรมบ้านฟัน</h1>
                <p class="text-gray-500 mt-2">กรุณาเข้าสู่ระบบ</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">อีเมล</label>
                    <input type="email" id="email" required class="mt-1 block w-full px-4 py-2 rounded-md border-gray-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                    <input type="password" id="password" required class="mt-1 block w-full px-4 py-2 rounded-md border-gray-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                </div>
                <p id="login-message" class="text-red-500 text-sm text-center hidden"></p>
                <button type="submit" class="w-full bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-700 transition duration-300 shadow-md">
                    เข้าสู่ระบบ
                </button>
            </form>
        </div>
    </div>


    <!-- App Container (Hidden by default) -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-8 max-w-7xl">
            <!-- Header -->
            <header class="flex flex-col md:flex-row justify-between items-center text-center md:text-left mb-8 gap-4">
                <div class="flex-grow">
                    <h1 class="text-4xl font-bold text-cyan-700">คลินิกทันตกรรมบ้านฟัน</h1>
                    <p class="text-gray-500 mt-2">ระบบรายงานรายรับและสรุปผลประจำเดือน/ปี</p>
                </div>
                <button id="logoutBtn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition duration-300 shadow-sm">
                    ออกจากระบบ
                </button>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column: Input Form -->
                <div class="lg:col-span-1">
                    <div class="card p-6 sticky top-8 border border-gray-100">
                        <h2 class="text-2xl font-bold mb-4 border-b pb-2 text-cyan-600">บันทึกรายการใหม่</h2>
                        <form id="recordForm" class="space-y-4">
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700">วันที่</label>
                                <input type="date" id="date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                            </div>
                            <div>
                                <label for="income" class="block text-sm font-medium text-gray-700">รายรับทั้งหมด (บาท)</label>
                                <input type="number" id="income" min="0" step="0.01" placeholder="เช่น 15000" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                            </div>
                            <div>
                                <label for="lab_cost" class="block text-sm font-medium text-gray-700">ค่า Lab (บาท)</label>
                                <input type="number" id="lab_cost" min="0" step="0.01" placeholder="เช่น 2500" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                            </div>
                            <div>
                                <label for="patient_count" class="block text-sm font-medium text-gray-700">จำนวนคนไข้</label>
                                <input type="number" id="patient_count" min="0" placeholder="เช่น 10" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                            </div>
                            <div>
                                <label for="notes" class="block text-sm font-medium text-gray-700">หมายเหตุ</label>
                                <textarea id="notes" rows="3" placeholder="รายละเอียดเพิ่มเติม..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-700 transition duration-300 shadow-md">
                                บันทึกข้อมูล
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Right Column: Data Display -->
                <div class="lg:col-span-2">
                    <div class="card p-6 border border-gray-100">
                        <!-- View Toggles and Filters -->
                        <div class="flex flex-wrap items-center justify-between mb-6 gap-4 border-b pb-6">
                            <div class="flex items-center gap-2">
                                <button id="showMonthlyViewBtn" class="px-4 py-2 text-sm font-bold bg-cyan-600 text-white rounded-md shadow">มุมมองรายเดือน</button>
                                <button id="showAnnualViewBtn" class="px-4 py-2 text-sm font-bold bg-gray-200 text-gray-700 rounded-md">มุมมองรายปี</button>
                            </div>
                            <!-- Actions & Filters -->
                            <div class="flex flex-wrap items-center gap-4">
                                <div id="monthlyFilterContainer" class="flex items-center gap-2">
                                    <label for="month_filter" class="text-sm font-medium">เลือกเดือน:</label>
                                    <input type="month" id="month_filter" class="rounded-md border-gray-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500 text-sm">
                                </div>
                                <div id="annualFilterContainer" class="flex items-center gap-2 hidden">
                                    <label for="year_filter" class="text-sm font-medium">เลือกปี:</label>
                                    <input type="number" id="year_filter" class="w-24 rounded-md border-gray-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500 text-sm" placeholder="2025">
                                </div>
                                <button id="exportCsvBtn" class="px-4 py-2 text-sm font-bold bg-green-600 text-white rounded-md hover:bg-green-700 shadow flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                    ส่งออก CSV
                                </button>
                            </div>
                        </div>
                        
                        <!-- Monthly View -->
                        <div id="monthlyView">
                            <h2 class="text-2xl font-bold text-cyan-600 mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                                สรุปข้อมูลรายเดือน
                            </h2>
                            <!-- Responsive Summary Cards -->
                            <div id="summary-cards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-8"></div>
                            
                            <div class="overflow-x-auto rounded-lg border border-gray-100">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">วันที่</th>
                                            <th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">รายรับ</th>
                                            <th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">ค่า Lab</th>
                                            <th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">คงเหลือ</th>
                                            <th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">รับจริง</th>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">คนไข้</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">หมายเหตุ</th>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">จัดการ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recordsTableBody" class="bg-white divide-y divide-gray-100"></tbody>
                                </table>
                                <div id="no-data-monthly" class="text-center py-12 text-gray-400 hidden">
                                    <p class="text-lg">ยังไม่มีข้อมูลสำหรับช่วงเวลานี้</p>
                                </div>
                            </div>
                        </div>

                        <!-- Annual View -->
                        <div id="annualView" class="hidden">
                            <h2 class="text-2xl font-bold text-cyan-600 mb-4">สรุปข้อมูลรายปี <span id="annualViewYear"></span></h2>
                            <div class="mb-6 h-[400px]">
                                <canvas id="annualChart"></canvas>
                            </div>
                            <div id="no-data-annual" class="text-center py-12 text-gray-400 hidden">
                                <p class="text-lg">ยังไม่มีข้อมูลสำหรับปีนี้</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-2xl opacity-0 transition-opacity duration-300 z-[100]">
        <p id="toast-message" class="font-medium"></p>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[60]">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm mx-4">
            <div class="text-center mb-6">
                <div class="bg-red-100 text-red-600 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                </div>
                <h3 class="text-xl font-bold text-gray-800">ยืนยันการลบข้อมูล</h3>
                <p class="text-gray-500 mt-2">ข้อมูลนี้จะถูกลบออกอย่างถาวรและไม่สามารถกู้คืนได้</p>
            </div>
            <div class="flex gap-3">
                <button id="cancelDelete" class="flex-1 px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 font-bold transition">ยกเลิก</button>
                <button id="confirmDelete" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold transition">ลบข้อมูล</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[60]">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg mx-4 overflow-y-auto max-h-[90vh]">
            <h3 class="text-2xl font-bold mb-6 border-b pb-4 text-cyan-600">แก้ไขรายการ</h3>
            <form id="editForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-date" class="block text-sm font-medium text-gray-700">วันที่</label>
                        <input type="date" id="edit-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                    </div>
                    <div>
                        <label for="edit-patient_count" class="block text-sm font-medium text-gray-700">จำนวนคนไข้</label>
                        <input type="number" id="edit-patient_count" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-income" class="block text-sm font-medium text-gray-700">รายรับทั้งหมด (บาท)</label>
                        <input type="number" id="edit-income" min="0" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                    </div>
                    <div>
                        <label for="edit-lab_cost" class="block text-sm font-medium text-gray-700">ค่า Lab (บาท)</label>
                        <input type="number" id="edit-lab_cost" min="0" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                    </div>
                </div>
                <div>
                    <label for="edit-notes" class="block text-sm font-medium text-gray-700">หมายเหตุ</label>
                    <textarea id="edit-notes" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500" placeholder="ระบุรายละเอียดเพิ่มเติม..."></textarea>
                </div>
                <div class="flex gap-3 pt-6 border-t mt-6">
                    <button type="button" id="cancelEdit" class="flex-1 px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 font-bold transition">ยกเลิก</button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 font-bold transition shadow-md">บันทึกการแก้ไข</button>
                </div>
            </form>
        </div>
    </div>


<script>
    // --- 1. Supabase Client Setup ---
    const SUPABASE_URL = 'https://nekghcpcuqsrxetiqvmn.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5la2doY3BjdXFzcnhldGlxdm1uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NzA0ODAsImV4cCI6MjA3MDI0NjQ4MH0.343Oimw3xQNF81k0QTijupa4Wzs0kbTYffxjhL12DMY';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- 2. DOM Elements ---
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('loginForm');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginMessage = document.getElementById('login-message');

    const monthlyView = document.getElementById('monthlyView');
    const annualView = document.getElementById('annualView');
    const showMonthlyViewBtn = document.getElementById('showMonthlyViewBtn');
    const showAnnualViewBtn = document.getElementById('showAnnualViewBtn');
    const monthlyFilterContainer = document.getElementById('monthlyFilterContainer');
    const annualFilterContainer = document.getElementById('annualFilterContainer');
    const monthFilter = document.getElementById('month_filter');
    const yearFilter = document.getElementById('year_filter');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    
    const recordForm = document.getElementById('recordForm');
    const recordsTableBody = document.getElementById('recordsTableBody');
    const summaryCardsContainer = document.getElementById('summary-cards');
    const noDataMonthly = document.getElementById('no-data-monthly');
    const annualChartCanvas = document.getElementById('annualChart').getContext('2d');
    const annualViewYear = document.getElementById('annualViewYear');
    const noDataAnnual = document.getElementById('no-data-annual');
    
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    const deleteModal = document.getElementById('deleteModal');
    const cancelDeleteBtn = document.getElementById('cancelDelete');
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    const editModal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    const cancelEditBtn = document.getElementById('cancelEdit');

    let recordIdToDelete = null;
    let recordIdToEdit = null;
    let annualChartInstance;

    // --- 3. Helpers ---
    const formatCurrency = (num) => (num || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    
    function showToast(message, isError = false) {
        toastMessage.textContent = message;
        toast.className = `fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-2xl transition-opacity duration-300 z-[100] ${isError ? 'bg-red-500' : 'bg-green-500'} opacity-100`;
        setTimeout(() => toast.classList.replace('opacity-100', 'opacity-0'), 3000);
    }

    // --- 4. Logic: Fetching & Summarizing ---
    async function fetchMonthlyRecords(year, month) {
        // Accounting cycle: 26th of last month to 25th of current month
        const endDate = `${year}-${String(month).padStart(2, '0')}-25`;
        let startYear = year, startMonth = month - 1;
        if (startMonth === 0) { startMonth = 12; startYear = year - 1; }
        const startDate = `${startYear}-${String(startMonth).padStart(2, '0')}-26`;

        const { data, error } = await supabaseClient
            .from('daily_records')
            .select('*')
            .gte('date', startDate)
            .lte('date', endDate)
            .order('date', { ascending: false });

        if (error) {
            showToast('ผิดพลาดในการดึงข้อมูล', true);
            return;
        }

        recordsTableBody.innerHTML = '';
        noDataMonthly.classList.toggle('hidden', data && data.length > 0);
        summaryCardsContainer.innerHTML = '';

        if (!data || data.length === 0) return;
        
        let totalIncome = 0, totalLabCost = 0, totalPatients = 0;
        const daysWorked = data.length; // Each entry represents one clinical day

        data.forEach(record => {
            const netBeforeSplit = record.income - record.lab_cost;
            const netTakeHome = netBeforeSplit / 2;
            totalIncome += record.income;
            totalLabCost += record.lab_cost;
            totalPatients += record.patient_count;

            const row = `
                <tr class="hover:bg-cyan-50 transition-colors text-sm">
                    <td class="px-4 py-4 whitespace-nowrap text-center font-medium">${record.date}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-right text-green-600 font-bold">${formatCurrency(record.income)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-right text-red-500">${formatCurrency(record.lab_cost)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-right text-gray-700">${formatCurrency(netBeforeSplit)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-right text-cyan-700 font-extrabold">${formatCurrency(netTakeHome)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-center">${record.patient_count}</td>
                    <td class="px-4 py-4 whitespace-normal text-left text-gray-500 text-xs max-w-[150px] truncate" title="${record.notes || ''}">${record.notes || '-'}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-center space-x-2">
                        <button class="edit-btn text-cyan-600 hover:underline font-bold" data-id="${record.id}">แก้ไข</button>
                        <button class="delete-btn text-red-600 hover:underline font-bold" data-id="${record.id}">ลบ</button>
                    </td>
                </tr>`;
            recordsTableBody.innerHTML += row;
        });

        const totalNetBeforeSplit = totalIncome - totalLabCost;
        const totalNetTakeHome = totalNetBeforeSplit / 2;

        // Populate Summary Cards
        const cardClass = "p-5 rounded-xl shadow-sm border-l-4 card";
        summaryCardsContainer.innerHTML = `
            <div class="${cardClass} bg-green-50 border-green-500 summary-card">
                <p class="text-xs text-green-700 font-bold uppercase tracking-wider mb-1">รายรับรวมทั้งหมด</p>
                <p class="text-2xl font-black text-green-800">฿${formatCurrency(totalIncome)}</p>
            </div>
            <div class="${cardClass} bg-red-50 border-red-500 summary-card">
                <p class="text-xs text-red-700 font-bold uppercase tracking-wider mb-1">ค่า Lab รวม</p>
                <p class="text-2xl font-black text-red-800">฿${formatCurrency(totalLabCost)}</p>
            </div>
            <div class="${cardClass} bg-orange-50 border-orange-500 summary-card">
                <p class="text-xs text-orange-700 font-bold uppercase tracking-wider mb-1">รายรับหลังหักค่า Lab</p>
                <p class="text-2xl font-black text-orange-800">฿${formatCurrency(totalNetBeforeSplit)}</p>
            </div>
            <div class="${cardClass} bg-cyan-50 border-cyan-500 summary-card">
                <p class="text-xs text-cyan-700 font-bold uppercase tracking-wider mb-1">รายได้ส่วนตัวสุทธิ</p>
                <p class="text-2xl font-black text-cyan-800">฿${formatCurrency(totalNetTakeHome)}</p>
            </div>
            <div class="${cardClass} bg-purple-50 border-purple-500 summary-card">
                <p class="text-xs text-purple-700 font-bold uppercase tracking-wider mb-1">จำนวนวันที่ลงคลินิก</p>
                <p class="text-2xl font-black text-purple-800">${daysWorked} วัน</p>
            </div>
            <div class="${cardClass} bg-blue-50 border-blue-500 summary-card">
                <p class="text-xs text-blue-700 font-bold uppercase tracking-wider mb-1">จำนวนคนไข้รวม</p>
                <p class="text-2xl font-black text-blue-800">${totalPatients.toLocaleString('th-TH')} ราย</p>
            </div>
        `;
    }

    async function displayAnnualSummary(year) {
        annualViewYear.textContent = year;
        const { data, error } = await supabaseClient
            .from('daily_records')
            .select('*')
            .gte('date', `${year-1}-12-26`)
            .lte('date', `${year}-12-25`);

        if (error) { showToast('ดึงข้อมูลรายปีล้มเหลว', true); return; }

        noDataAnnual.classList.toggle('hidden', data && data.length > 0);
        if (annualChartInstance) annualChartInstance.destroy();
        if (!data || data.length === 0) return;

        const monthlyStats = Array.from({ length: 12 }, () => ({ income: 0, net: 0, days: 0 }));

        data.forEach(record => {
            const d = new Date(record.date);
            let mIdx = d.getMonth();
            if (d.getDate() >= 26) mIdx = (mIdx + 1) % 12;
            monthlyStats[mIdx].income += record.income;
            monthlyStats[mIdx].net += (record.income - record.lab_cost) / 2;
            monthlyStats[mIdx].days += 1;
        });

        renderAnnualChart(monthlyStats);
    }
    
    function renderAnnualChart(stats) {
        const labels = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
        annualChartInstance = new Chart(annualChartCanvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'รายรับรวม', data: stats.map(s => s.income), backgroundColor: '#22c55e', borderRadius: 6 },
                    { label: 'รายได้สุทธิ', data: stats.map(s => s.net), backgroundColor: '#0891b2', borderRadius: 6 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { callback: v => v.toLocaleString() + ' ฿' }}},
                plugins: { tooltip: { callbacks: { label: c => `${c.dataset.label}: ${formatCurrency(c.raw)} ฿` }}}
            }
        });
    }

    // --- 5. CRUD Operations ---
    async function addRecord(e) {
        e.preventDefault();
        const payload = {
            date: document.getElementById('date').value,
            income: parseFloat(document.getElementById('income').value),
            lab_cost: parseFloat(document.getElementById('lab_cost').value),
            patient_count: parseInt(document.getElementById('patient_count').value),
            notes: document.getElementById('notes').value
        };
        const { error } = await supabaseClient.from('daily_records').insert([payload]);
        if (error) showToast('บันทึกล้มเหลว: ' + error.message, true);
        else {
            showToast('บันทึกข้อมูลเรียบร้อยแล้ว');
            recordForm.reset();
            document.getElementById('date').valueAsDate = new Date();
            refreshCurrentView();
        }
    }
    
    async function updateRecord(e) {
        e.preventDefault();
        const payload = {
            date: document.getElementById('edit-date').value,
            income: parseFloat(document.getElementById('edit-income').value),
            lab_cost: parseFloat(document.getElementById('edit-lab_cost').value),
            patient_count: parseInt(document.getElementById('edit-patient_count').value),
            notes: document.getElementById('edit-notes').value
        };
        const { error } = await supabaseClient.from('daily_records').update(payload).eq('id', recordIdToEdit);
        if (error) showToast('อัปเดตล้มเหลว', true);
        else {
            showToast('แก้ไขข้อมูลสำเร็จ');
            closeEditModal();
            refreshCurrentView();
        }
    }

    async function deleteRecord(id) {
        const { error } = await supabaseClient.from('daily_records').delete().eq('id', id);
        if (error) showToast('ลบข้อมูลไม่สำเร็จ', true);
        else { showToast('ลบรายการสำเร็จ'); refreshCurrentView(); }
        closeDeleteModal();
    }

    async function exportToCsv() {
        const [year, month] = monthFilter.value.split('-').map(Number);
        const endDate = `${year}-${String(month).padStart(2, '0')}-25`;
        let startYear = year, startMonth = month - 1;
        if (startMonth === 0) { startMonth = 12; startYear = year - 1; }
        const startDate = `${startYear}-${String(startMonth).padStart(2, '0')}-26`;

        const { data, error } = await supabaseClient
            .from('daily_records')
            .select('*')
            .gte('date', startDate)
            .lte('date', endDate)
            .order('date', { ascending: true });

        if (error || !data || data.length === 0) { showToast('ไม่มีข้อมูลให้ส่งออก', true); return; }

        const headers = ['วันที่', 'รายรับ', 'ค่า Lab', 'คงเหลือ', 'รายได้ส่วนตัว', 'คนไข้', 'หมายเหตุ'];
        const csvRows = [headers.join(',')];
        
        data.forEach(r => {
            const row = [r.date, r.income, r.lab_cost, r.income - r.lab_cost, (r.income - r.lab_cost)/2, r.patient_count, `"${(r.notes||'').replace(/"/g, '""')}"`];
            csvRows.push(row.join(','));
        });

        const blob = new Blob(['\uFEFF' + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `BaanFun-Report-${monthFilter.value}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // --- 6. Event Handlers & View Control ---
    function refreshCurrentView() {
        if (!monthlyView.classList.contains('hidden')) {
            const [y, m] = monthFilter.value.split('-').map(Number);
            fetchMonthlyRecords(y, m);
        } else {
            displayAnnualSummary(parseInt(yearFilter.value));
        }
    }

    function switchView(view) {
        const isM = view === 'monthly';
        monthlyView.classList.toggle('hidden', !isM);
        annualView.classList.toggle('hidden', isM);
        monthlyFilterContainer.classList.toggle('hidden', !isM);
        annualFilterContainer.classList.toggle('hidden', isM);
        
        showMonthlyViewBtn.className = isM ? 'px-4 py-2 text-sm font-bold bg-cyan-600 text-white rounded-md shadow' : 'px-4 py-2 text-sm font-bold bg-gray-200 text-gray-700 rounded-md';
        showAnnualViewBtn.className = !isM ? 'px-4 py-2 text-sm font-bold bg-cyan-600 text-white rounded-md shadow' : 'px-4 py-2 text-sm font-bold bg-gray-200 text-gray-700 rounded-md';
        
        refreshCurrentView();
    }

    async function openEditModal(id) {
        recordIdToEdit = id;
        const { data, error } = await supabaseClient.from('daily_records').select('*').eq('id', id).single();
        if (error) return;
        document.getElementById('edit-date').value = data.date;
        document.getElementById('edit-income').value = data.income;
        document.getElementById('edit-lab_cost').value = data.lab_cost;
        document.getElementById('edit-patient_count').value = data.patient_count;
        document.getElementById('edit-notes').value = data.notes || '';
        editModal.classList.remove('hidden');
    }
    
    const closeEditModal = () => editModal.classList.add('hidden');
    const openDeleteModal = (id) => { recordIdToDelete = id; deleteModal.classList.remove('hidden'); };
    const closeDeleteModal = () => deleteModal.classList.add('hidden');

    // --- 7. Auth Logic ---
    async function handleLogin(e) {
        e.preventDefault();
        const { error } = await supabaseClient.auth.signInWithPassword({ email: loginForm.email.value, password: loginForm.password.value });
        if (error) { loginMessage.textContent = 'อีเมลหรือรหัสผ่านไม่ถูกต้อง'; loginMessage.classList.remove('hidden'); }
    }

    const handleLogout = async () => await supabaseClient.auth.signOut();

    // --- 8. Setup & Init ---
    loginForm.addEventListener('submit', handleLogin);
    logoutBtn.addEventListener('click', handleLogout);
    recordForm.addEventListener('submit', addRecord);
    editForm.addEventListener('submit', updateRecord);
    monthFilter.addEventListener('change', refreshCurrentView);
    yearFilter.addEventListener('change', refreshCurrentView);
    showMonthlyViewBtn.addEventListener('click', () => switchView('monthly'));
    showAnnualViewBtn.addEventListener('click', () => switchView('annual'));
    exportCsvBtn.addEventListener('click', exportToCsv);
    cancelEditBtn.addEventListener('click', closeEditModal);
    cancelDeleteBtn.addEventListener('click', closeDeleteModal);
    confirmDeleteBtn.addEventListener('click', () => deleteRecord(recordIdToDelete));
    
    recordsTableBody.addEventListener('click', e => {
        const id = e.target.dataset.id;
        if (e.target.classList.contains('delete-btn')) openDeleteModal(id);
        if (e.target.classList.contains('edit-btn')) openEditModal(id);
    });

    supabaseClient.auth.onAuthStateChange((event, session) => {
        if (session) {
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            const now = new Date();
            monthFilter.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            yearFilter.value = now.getFullYear();
            document.getElementById('date').valueAsDate = now;
            refreshCurrentView();
        } else {
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }
    });
</script>

</body>
</html>
